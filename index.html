<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>نظام الطلبات المطور 2.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/ar.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap');
    
    /* المتغيرات الأساسية للألوان والظلال */
    :root {
      --primary-orange: #ef5b0c;
      --primary-orange-hover: #e0520b;
      --bg-light: #f8f9fa;
      --text-light: #212529;
      --card-light: #ffffff;
      --border-light: #e0e0e0;
      --shadow-light: rgba(0, 0, 0, 0.08);

      --bg-dark: #111827;
      --text-dark: #ffffff;
      --card-dark: #1f2937;
      --border-dark: #374151;
      --shadow-dark: rgba(0, 0, 0, 0.4);
    }
    
    * {
      font-family: 'Tajawal', sans-serif;
      /* تحسين حجم الخط الافتراضي وتنعيم الخط */
      font-size: 1rem; /* 16px */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    body {
      transition: background-color 0.3s ease, color 0.3s ease;
      background-color: var(--bg-light); /* قيمة افتراضية للوضع الفاتح */
      color: var(--text-light); /* قيمة افتراضية للوضع الفاتح */
    }

    body.dark { 
      background-color: var(--bg-dark); 
      color: var(--text-dark); 
    }
    
    body.light { 
      background-color: var(--bg-light); 
      color: var(--text-light); 
    }
    
    /* تحسينات عامة على عناصر الإدخال */
    select, input:not([type="checkbox"]), textarea {
      appearance: none;
      padding: 0.75rem 1rem; /* زيادة حجم البادينج */
      border-radius: 0.6rem; /* تدوير أكثر */
      border: 1px solid var(--border-light);
      background-color: var(--card-light);
      color: var(--text-light);
      transition: all 0.2s ease-in-out;
    }
    body.dark select, 
    body.dark input:not([type="checkbox"]), 
    body.dark textarea {
      border: 1px solid var(--border-dark);
      background-color: var(--card-dark);
      color: var(--text-dark);
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(239, 91, 12, 0.3); /* ظل أوسع وأكثر نعومة */
      border-color: var(--primary-orange);
    }

    /* أزرار Tailwind المخصصة */
    .btn-primary {
      background-color: var(--primary-orange);
      color: white;
      transition: background-color 0.2s ease;
    }
    .btn-primary:hover {
      background-color: var(--primary-orange-hover);
    }

    .btn-secondary {
      background-color: var(--card-light);
      color: var(--text-light);
      border: 1px solid var(--border-light);
      transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
    }
    .btn-secondary:hover {
      background-color: var(--border-light);
    }
    body.dark .btn-secondary {
      background-color: var(--card-dark);
      color: var(--text-dark);
      border: 1px solid var(--border-dark);
    }
    body.dark .btn-secondary:hover {
      background-color: #2e3b4d; /* درجة أغمق قليلًا من الكارد الداكن */
      border-color: #4b5a70;
    }


    /* الإشعارات */
    .notification {
      position: fixed;
      top: 20px; /* أقرب للزاوية العليا */
      right: 20px; /* تظهر من اليمين */
      transform: translateX(100%); /* تبدأ خارج الشاشة */
      padding: 15px 25px; /* تعديل البادينج */
      border-radius: 10px; /* تدوير أكثر */
      background: var(--primary-orange);
      color: white;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); /* ظل أنعم */
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      max-width: 300px; /* عرض ثابت */
      text-align: right; /* محاذاة لليمين */
      font-size: 1rem;
      transition: all 0.4s ease-out; /* انتقال شامل وناعم */
    }

    .notification.show {
      opacity: 1;
      transform: translateX(0); /* تدخل من اليمين */
      pointer-events: auto;
    }
    
    .skeleton {
      background: linear-gradient(90deg, var(--border-dark) 25%, #3c4758 50%, var(--border-dark) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s infinite;
    }
    
    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    .task-card {
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); /* انتقال أكثر حيوية */
      border: 1px solid var(--border-light); /* حدود افتراضية */
    }
    body.dark .task-card {
      border: 1px solid var(--border-dark);
    }
    
    .task-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15); /* ظل أكبر وأكثر وضوحا عند التمرير */
    }
    body.dark .task-card:hover {
      box-shadow: 0 10px 25px var(--shadow-dark);
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn { 
      0% { opacity: 0; transform: translateY(10px); } /* تبدأ من الأسفل قليلا */
      100% { opacity: 1; transform: translateY(0); }
    }
    
    /* الظلال الخاصة بالأولويات */
    .priority-high {
      box-shadow: 0 0 0 2px #e74c3c;
    }
    
    .priority-medium {
      box-shadow: 0 0 0 2px #f39c12;
    }
    
    .priority-low {
      box-shadow: 0 0 0 2px #2ecc71;
    }
    
    /* تصميم الشريط الجانبي */
    .sidebar {
      transition: width 0.3s ease;
      background-color: var(--card-dark); /* توحيد الخلفية مع بطاقات الوضع الداكن */
    }
    
    .sidebar.collapsed {
      width: 80px; /* زيادة العرض قليلا لاستيعاب أيقونات أكبر */
    }
    .sidebar.collapsed .sidebar-text {
        opacity: 0;
        width: 0;
        overflow: hidden;
        margin-right: 0; /* إزالة الهامش */
    }
    .sidebar-text {
        transition: opacity 0.3s ease, width 0.3s ease, margin-right 0.3s ease;
        white-space: nowrap; /* منع التفاف النص */
    }

    .tooltip {
      position: relative;
    }
    
    .tooltip:hover:after {
      content: attr(data-tooltip);
      position: absolute;
      right: 110%; /* ابعد قليلا عن العنصر */
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.85); /* ظل أغمق للتولتييب */
      color: white;
      padding: 6px 10px; /* بادينج أكبر */
      border-radius: 6px; /* تدوير أكثر */
      white-space: nowrap;
      z-index: 100; /* تأكد أنه يظهر فوق كل شيء */
      margin-right: 10px;
      font-size: 0.85rem; /* حجم خط أصغر قليلا */
    }
    
    /* انيميشن جديد للبطاقات (عند الإضافة مثلاً) */
    .task-card.new {
      animation: pulse 2s ease-out infinite; /* انيميشن أنعم */
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(239, 91, 12, 0.4); } /* بداية الانيميشن أغمق قليلا */
      70% { box-shadow: 0 0 0 15px rgba(239, 91, 12, 0); } /* انتشار أكبر */
      100% { box-shadow: 0 0 0 0 rgba(239, 91, 12, 0); }
    }
    
    /* تحسين التبويبات */
    .tab {
      position: relative;
      overflow: hidden;
      color: var(--text-dark); /* اللون الافتراضي للأيقونات والنصوص في الوضع الداكن */
      justify-content: flex-end; /* المحاذاة لليمين */
    }
    .tab span { /* للنص داخل التاب */
      margin-right: 0.75rem; /* مسافة بين الأيقونة والنص */
    }
    .tab i { /* للأيقونات داخل التاب */
      font-size: 1.6rem; /* أيقونات أكبر قليلا */
    }

    .tab::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 3px; /* شريط سميك */
      background: var(--primary-orange);
      transition: width 0.3s ease;
    }
    
    .tab.active::after {
      width: 100%;
    }
    .tab.active {
      color: var(--primary-orange); /* لون الأيقونة والنص نشط */
    }
    body.light .tab.active {
      color: var(--primary-orange);
    }
    body.light .tab {
      color: var(--text-light);
    }


    /* تصميم المودال */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6); /* خلفية أغمق للمودال */
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease-out, visibility 0.3s ease-out;
    }
    
    .modal-backdrop.show {
      opacity: 1;
      visibility: visible;
    }
    
    .modal-content {
      transform: translateY(20px) scale(0.95); /* تبدأ أصغر قليلا ومن الأسفل */
      transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      background-color: var(--card-light);
      box-shadow: 0 15px 30px var(--shadow-light); /* ظل أكبر للمودال */
    }
    body.dark .modal-content {
      background-color: var(--card-dark);
      box-shadow: 0 15px 30px var(--shadow-dark);
    }
    
    .modal-backdrop.show .modal-content {
      transform: translateY(0) scale(1);
    }
    
    /* تصميم زر العائم */
    .floating-button {
      position: fixed;
      bottom: 30px;
      left: 30px; /* تغيير مكانه ليناسب اللغة العربية */
      height: 60px;
      width: 60px;
      border-radius: 50%; /* دائري بالكامل */
      background: var(--primary-orange);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
      z-index: 40;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    .floating-button:hover {
      transform: scale(1.05) translateY(-3px); /* يكبر ويرتفع قليلا */
      box-shadow: 0 8px 18px rgba(0,0,0,0.4);
      background: var(--primary-orange-hover);
    }
    
    /* سكرول بار مخصص */
    ::-webkit-scrollbar {
      width: 10px; /* عرض أكبر */
      height: 10px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--card-light); /* يتناسق مع الخلفية */
      border-radius: 10px;
    }
    body.dark ::-webkit-scrollbar-track {
      background: var(--card-dark);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--primary-orange);
      border-radius: 10px;
      border: 2px solid var(--card-light); /* حدود حول شريط التمرير */
    }
    body.dark ::-webkit-scrollbar-thumb {
      border: 2px solid var(--card-dark);
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-orange-hover);
    }
    
    /* تحسين قسم البحث */
    .search-container {
      position: relative;
    }
    
    .search-results {
      position: absolute;
      top: calc(100% + 5px); /* مسافة قليلة من حقل البحث */
      left: 0;
      right: 0;
      max-height: 250px; /* ارتفاع أقل */
      overflow-y: auto;
      background: var(--card-light);
      border-radius: 8px;
      box-shadow: 0 10px 25px var(--shadow-light);
      z-index: 20;
      display: none;
      border: 1px solid var(--border-light);
    }
    body.dark .search-results {
      background: var(--card-dark);
      box-shadow: 0 10px 25px var(--shadow-dark);
      border: 1px solid var(--border-dark);
    }
    
    .search-container:focus-within .search-results {
      display: block;
    }

    /* تصميم التعليقات */
    .comment {
      position: relative;
      padding: 15px; /* بادينج أكبر */
      border-radius: 10px; /* تدوير أكثر */
      margin-bottom: 15px; /* مسافة أكبر بين التعليقات */
      background-color: var(--bg-light); /* خلفية خفيفة للتعليق */
      box-shadow: 0 2px 8px rgba(0,0,0,0.05); /* ظل خفيف */
    }
    body.dark .comment {
      background-color: var(--card-dark); /* خلفية داكنة للتعليق */
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .comment:before {
      content: '';
      position: absolute;
      top: 15px;
      left: -8px; /* تغيير الاتجاه ليناسب RTL */
      width: 0;
      height: 0;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
      border-right: 8px solid currentColor; /* تغيير الاتجاه */
    }

    /* تصميم علامات التمييز (التاغات) */
    .tag {
      display: inline-block;
      padding: 5px 12px; /* بادينج أكبر */
      border-radius: 18px; /* تدوير أكثر للحواف */
      font-size: 0.8rem; /* حجم خط أصغر قليلا */
      margin-left: 6px; /* مسافة من اليسار ليناسب RTL */
      white-space: nowrap;
      font-weight: 500; /* خط أثقل قليلا */
      border: 1px solid transparent; /* حدود شفافة */
      transition: all 0.2s ease;
    }
    .tag:hover {
      opacity: 0.8;
    }
    .tag-checkbox {
      margin-left: 0.5rem; /* مسافة بين التشيك بوكس والنص */
    }
    .tag-checkbox:checked + span {
      font-weight: bold;
    }


    /* تصميم شريط التقدم */
    .progress-bar {
      height: 10px; /* ارتفاع أكبر */
      border-radius: 5px; /* تدوير أكثر */
      background: rgba(255, 255, 255, 0.15); /* خلفية شفافة */
      overflow: hidden;
    }
    body.light .progress-bar {
      background: rgba(0, 0, 0, 0.08);
    }

    .progress-bar-fill {
      height: 100%;
      border-radius: 5px;
      background: var(--primary-orange);
      transition: width 0.5s ease;
    }

    /* انيميشن إضافي للعناصر */
    .slide-in {
      animation: slideIn 0.4s ease-out forwards; /* انيميشن أطول قليلا */
    }

    @keyframes slideIn {
      from { transform: translateX(50px); opacity: 0; } /* تبدأ من مسافة أكبر */
      to { transform: translateX(0); opacity: 1; }
    }

    .bounce {
      animation: bounce 0.6s ease-in-out; /* انيميشن أطول وأكثر نعومة */
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-15px); } /* ارتداد أعلى */
    }

    /* تحسينات عامة للمحتوى الرئيسي */
    #app {
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* تحسينات لبطاقات الإحصاءات في لوحة التحكم */
    .stat-card {
        background-color: var(--card-light);
        box-shadow: 0 4px 12px var(--shadow-light);
        border-radius: 1.25rem; /* تدوير أكبر */
        padding: 1.5rem;
        transition: all 0.3s ease;
    }
    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 15px var(--shadow-light);
    }
    body.dark .stat-card {
        background-color: var(--card-dark);
        box-shadow: 0 4px 12px var(--shadow-dark);
    }

    /* تحسين الجداول */
    table {
        border-collapse: separate; /* لجعل تدوير الزوايا يعمل */
        border-spacing: 0 8px; /* مسافة بين الصفوف */
    }
    th, td {
        padding: 12px 16px; /* بادينج أكبر */
        text-align: right; /* محاذاة لليمين افتراضيا */
    }
    thead th {
        background-color: rgba(0, 0, 0, 0.05); /* خلفية خفيفة للرأس */
        font-weight: 600;
        border-bottom: 2px solid var(--border-light);
    }
    body.dark thead th {
        background-color: rgba(255, 255, 255, 0.05);
        border-bottom: 2px solid var(--border-dark);
    }
    tbody tr {
        background-color: var(--card-light);
        border-radius: 8px;
        transition: background-color 0.2s ease, transform 0.2s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.03); /* ظل خفيف جدا لكل صف */
    }
    body.dark tbody tr {
        background-color: var(--card-dark);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    tbody tr:hover {
        background-color: rgba(239, 91, 12, 0.05); /* تأثير هوفر خفيف بلون البرتقالي */
        transform: scale(1.01);
    }
    body.dark tbody tr:hover {
        background-color: rgba(239, 91, 12, 0.1);
    }

    /* تحسينات لـ Chart.js */
    .chartjs-render-monitor {
        background-color: transparent !important; /* لضمان شفافية الخلفية */
    }
  </style>
</head>
<body class="dark min-h-screen">
  <div class="flex">
    <div class="sidebar min-h-screen p-4 text-white flex flex-col items-center" id="sidebar">
      <button class="mb-8 text-3xl text-gray-400 hover:text-white transition-colors" id="toggle-sidebar">
        <em class="ph ph-list"></em>
      </button>
      
      <div class="space-y-4 w-full">
        <button class="tooltip tab flex items-center w-full p-3 rounded-xl hover:bg-gray-700 transition-all" data-tooltip="لوحة التحكم" data-section="dashboard">
          <em class="ph ph-chart-pie text-2xl"></em>
          <span class="sidebar-text mr-3">لوحة التحكم</span>
        </button>
        
        <button class="tooltip tab active flex items-center w-full p-3 rounded-xl bg-gray-800 text-white transition-all" data-tooltip="الطلبات" data-section="tasks">
          <em class="ph ph-clipboard-text text-2xl"></em>
          <span class="sidebar-text mr-3">الطلبات</span>
        </button>
        
        <button class="tooltip tab flex items-center w-full p-3 rounded-xl hover:bg-gray-700 transition-all" data-tooltip="التقارير" data-section="reports">
          <em class="ph ph-chart-line text-2xl"></em>
          <span class="sidebar-text mr-3">التقارير</span>
        </button>
        
        <button class="tooltip tab flex items-center w-full p-3 rounded-xl hover:bg-gray-700 transition-all" data-tooltip="الإعدادات" data-section="settings">
          <em class="ph ph-gear text-2xl"></em>
          <span class="sidebar-text mr-3">الإعدادات</span>
        </button>
      </div>
      
      <div class="mt-auto w-full">
        <button class="tooltip flex items-center w-full p-3 rounded-xl hover:bg-gray-700 transition-all" data-tooltip="المستخدم">
          <em class="ph ph-user-circle text-2xl"></em>
          <span class="sidebar-text mr-3">المستخدم</span>
        </button>
      </div>
    </div>
    
    <div class="flex-1 overflow-x-hidden">
      <div class="max-w-7xl mx-auto px-4 py-8" id="app"></div>
    </div>
  </div>
  
  <div class="notification" id="notification"></div>
  
  <button class="floating-button" id="add-task-btn">
    <em class="ph ph-plus text-2xl"></em>
  </button>
  
  <div class="modal-backdrop" id="task-modal">
    <div class="modal-content max-w-3xl w-full rounded-2xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-[var(--primary-orange)]" id="modal-title">إضافة طلب جديد</h2>
        <button class="text-gray-400 hover:text-white text-2xl transition-colors" id="close-modal">
          <em class="ph ph-x"></em>
        </button>
      </div>
      
      <div id="task-form"></div>
    </div>
  </div>
  
  <div class="modal-backdrop" id="task-details-modal">
    <div class="modal-content max-w-4xl w-full rounded-2xl shadow-lg p-6 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-[var(--primary-orange)]">تفاصيل الطلب</h2>
        <button class="text-gray-400 hover:text-white text-2xl transition-colors" id="close-details-modal">
          <em class="ph ph-x"></em>
        </button>
      </div>
      
      <div id="task-details-content"></div>
    </div>
  </div>
  
  <div class="modal-backdrop" id="confirm-modal">
    <div class="modal-content max-w-md w-full rounded-2xl shadow-lg p-6">
      <h2 class="text-xl font-bold mb-4">تأكيد الحذف</h2>
      <p class="mb-6">هل أنت متأكد من رغبتك في حذف هذا الطلب؟ لا يمكن التراجع عن هذه العملية.</p>
      <div class="flex justify-end gap-3">
        <button id="cancel-delete" class="px-4 py-2 rounded-lg btn-secondary transition">إلغاء</button>
        <button id="confirm-delete" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition">حذف</button>
      </div>
    </div>
  </div>
  
  <script>
    // متغيرات عامة
    let tasks = [];
    let editId = null;
    let darkMode = true;
    let sidebarCollapsed = false;
    let filteredTasks = [];
    let currentSort = { field: null, ascending: true };
    let currentFilter = { department: null, status: null, priority: null, tags: [] };
    let searchTerm = '';
    let activeSection = 'tasks';
    let comments = {};
    let activityLog = [];
    let deleteTaskId = null;
    let teamMembers = [
      { id: 1, name: "أحمد الأحمد", role: "مدير مشاريع", avatar: "أ" },
      { id: 2, name: "نوف السعيد", role: "مصمم", avatar: "ن" },
      { id: 3, name: "محمد العبدالله", role: "مطور", avatar: "م" },
      { id: 4, name: "سارة الخالد", role: "مدير حساب", avatar: "س" }
    ];
    
    // تعريف الأولويات
    const priorities = {
      "عالي": { color: "#e74c3c", icon: "ph-warning" },
      "متوسط": { color: "#f39c12", icon: "ph-clock" },
      "منخفض": { color: "#2ecc71", icon: "ph-caret-down" }
    };
    
    // تعريف الأقسام
    const departments = {
      "كرييتف": { color: "#a3e635", icon: "ph-paint-brush" },
      "سوشال ميديا": { color: "#f472b6", icon: "ph-chat-centered-text" },
      "ماركتنق": { color: "#f87171", icon: "ph-chart-line-up" },
      "كواليتي": { color: "#fde047", icon: "ph-check-square" },
      "الشراكات": { color: "#34d399", icon: "ph-handshake" },
      "سويتر": { color: "#60a5fa", icon: "ph-twitter-logo" },
      "اوبريشن": { color: "#a78bfa", icon: "ph-gear" },
      "خدمة عملاء": { color: "#fb923c", icon: "ph-headset" },
      "تقنية": { color: "#22d3ee", icon: "ph-code" }
    };
    
    // تعريف الحالات
    const statuses = {
      "غير منجز": { color: "#e74c3c", icon: "ph-x-circle" },
      "منجز": { color: "#27ae60", icon: "ph-check-circle" },
      "جاري العمل": { color: "#3498db", icon: "ph-spinner" },
      "انتظار الرد": { color: "#8e44ad", icon: "ph-hourglass" },
      "انتظار المحتوى": { color: "#f39c12", icon: "ph-file-text" },
      "معلق": { color: "#6e4d2b", icon: "ph-pause" },
      "ملغي": { color: "#000", icon: "ph-prohibit" },
      "اهمية": { color: "#2ecc71", icon: "ph-star" }
    };

    // تعريف الوسوم (التاغات)
    const tagsOptions = [
      { id: "عاجل", color: "#e74c3c" },
      { id: "مهم", color: "#f39c12" },
      { id: "جديد", color: "#3498db" },
      { id: "معقد", color: "#9b59b6" },
      { id: "بسيط", color: "#2ecc71" },
      { id: "يحتاج مراجعة", color: "#1abc9c" },
      { id: "خاص", color: "#34495e" },
      { id: "تعديل", color: "#f1c40f" }
    ];
    
    // تحميل البيانات من التخزين المحلي
    try {
      tasks = JSON.parse(localStorage.getItem("tasks") || "[]");
      comments = JSON.parse(localStorage.getItem("comments") || "{}");
      activityLog = JSON.parse(localStorage.getItem("activityLog") || "[]");
      darkMode = localStorage.getItem("darkMode") === "false" ? false : true;
      
      // تعيين أولوية افتراضية للمهام القديمة
      tasks = tasks.map(t => ({
        ...t,
        priority: t.priority || "متوسط",
        assignedTo: t.assignedTo || null,
        tags: t.tags || [],
        attachments: t.attachments || []
      }));
      
      localStorage.setItem("tasks", JSON.stringify(tasks));
    } catch (e) {
      console.error("خطأ في قراءة البيانات:", e);
      tasks = [];
      comments = {};
      activityLog = [];
    }
    
    // دالة مساعدة للحصول على قيمة عنصر
    function val(id) {
      const el = document.getElementById(id);
      return el ? el.value || "" : "";
    }
    
    // دالة تحويل اللون من هيكس إلى rgba
    function hexToRgba(hex, alpha) {
      try {
        const r = parseInt(hex.slice(1,3), 16);
        const g = parseInt(hex.slice(3,5), 16);
        const b = parseInt(hex.slice(5,7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      } catch (e) {
        console.error("خطأ في تحويل اللون:", e);
        return `rgba(0, 0, 0, ${alpha})`;
      }
    }
    
    // إظهار إشعارات
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type === 'error' ? 'bg-red-600' : 'bg-[var(--primary-orange)]'} show`;

      // إزالة الإشعار بعد 3 ثواني
      setTimeout(() => {
        notification.classList.remove('show');
        // إزالة الرسالة بعد إخفاء الأنيميشن بالكامل
        setTimeout(() => {
            notification.textContent = '';
        }, 400); // نفس مدة transition في CSS
      }, 3000);
    }
    
    // إضافة نشاط جديد في السجل
    function logActivity(action, taskId, details = '') {
      const task = tasks.find(t => t.id === taskId);
      const logEntry = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        action,
        taskId,
        taskTitle: task ? task.title : 'طلب محذوف',
        details,
        user: 'المستخدم الحالي' // يمكن تغييره لاحقًا مع نظام المستخدمين
      };
      
      activityLog.unshift(logEntry);
      if (activityLog.length > 200) {
        activityLog = activityLog.slice(0, 200);
      }
      
      localStorage.setItem("activityLog", JSON.stringify(activityLog));
    }
    
    // دالة تحديث عنصر واجهة المستخدم بناءً على القسم النشط
    function updateUI() {
      checkUpcomingDeadlines();

      // التبديل بين الأقسام
      document.querySelectorAll('.tab').forEach(tab => {
        const section = tab.getAttribute('data-section');
        if (section === activeSection) {
          tab.classList.add('active', 'bg-gray-800'); // Note: bg-gray-800 will be overridden by the .active css for color
        } else {
          tab.classList.remove('active', 'bg-gray-800');
        }
      });
      
      // تطبيق الوضع الداكن/الفاتح على الـ body
      document.body.classList.remove('dark', 'light');
      document.body.classList.add(darkMode ? 'dark' : 'light');

      // إنشاء المحتوى بناءً على القسم النشط
      switch (activeSection) {
        case 'dashboard':
          renderDashboard();
          break;
        case 'tasks':
          renderTasks();
          break;
        case 'reports':
          renderReports();
          break;
        case 'settings':
          renderSettings();
          break;
        default:
          renderTasks();
      }
    }
    
    // دالة إنشاء لوحة التحكم
    function renderDashboard() {
      const totalTasks = tasks.length;
      const completedTasks = tasks.filter(t => t.status === "منجز").length;
      const pendingTasks = tasks.filter(t => t.status === "غير منجز").length;
      const inProgressTasks = tasks.filter(t => t.status === "جاري العمل").length;
      const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
      
      // حساب الطلبات حسب القسم
      const departmentCounts = {};
      Object.keys(departments).forEach(dept => {
        departmentCounts[dept] = tasks.filter(t => t.department === dept).length;
      });
      
      // حساب الطلبات حسب الحالة
      const statusCounts = {};
      Object.keys(statuses).forEach(status => {
        statusCounts[status] = tasks.filter(t => t.status === status).length;
      });
      
      // حساب الطلبات المتأخرة
      const now = new Date();
      const overdueTasks = tasks.filter(t => {
        if (!t.deadline || t.status === "منجز" || t.status === "ملغي") return false;
        return new Date(t.deadline) < now;
      });
      
      // حساب متوسط وقت إنجاز الطلبات (بالأيام)
      let avgCompletionTime = 0;
      const completedTasksWithTime = tasks.filter(t => {
        return t.status === "منجز" && t.completedAt && t.createdAt;
      });
      
      if (completedTasksWithTime.length > 0) {
        const totalDays = completedTasksWithTime.reduce((sum, task) => {
          const created = new Date(task.createdAt);
          const completed = new Date(task.completedAt || task.createdAt);
          const diffTime = Math.abs(completed - created);
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          return sum + diffDays;
        }, 0);
        
        avgCompletionTime = (totalDays / completedTasksWithTime.length).toFixed(1);
      }
      
      // البيانات لرسم المخطط
      const last7Days = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        last7Days.push(date.toISOString().split('T')[0]);
      }
      
      const newTasksPerDay = last7Days.map(day => {
        return tasks.filter(t => t.createdAt && t.createdAt.startsWith(day)).length;
      });
      
      const completedTasksPerDay = last7Days.map(day => {
        return tasks.filter(t => t.completedAt && t.completedAt.startsWith(day)).length;
      });
      
      const app = document.getElementById("app");
      app.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h1 class="text-3xl font-bold">لوحة التحكم</h1>
          <div class="flex gap-4">
            <button onclick="toggleMode()" class="px-5 py-2 rounded-full btn-primary flex items-center gap-2">
              <i class="ph ${darkMode ? 'ph-sun' : 'ph-moon'}"></i>
              ${darkMode ? "الوضع النهاري" : "الوضع الليلي"}
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="stat-card flex items-center justify-between">
            <div>
              <h3 class="text-base text-gray-500 mb-1">إجمالي الطلبات</h3>
              <p class="text-3xl font-extrabold">${totalTasks}</p>
            </div>
            <div class="text-4xl text-blue-500">
              <i class="ph ph-clipboard-text"></i>
            </div>
          </div>
          <div class="stat-card flex items-center justify-between">
            <div>
              <h3 class="text-base text-gray-500 mb-1">الطلبات المنجزة</h3>
              <p class="text-3xl font-extrabold">${completedTasks}</p>
            </div>
            <div class="text-4xl text-green-500">
              <i class="ph ph-check-circle"></i>
            </div>
          </div>
          <div class="stat-card flex items-center justify-between">
            <div>
              <h3 class="text-base text-gray-500 mb-1">الطلبات المتأخرة</h3>
              <p class="text-3xl font-extrabold">${overdueTasks.length}</p>
            </div>
            <div class="text-4xl text-red-500">
              <i class="ph ph-clock-countdown"></i>
            </div>
          </div>
          <div class="stat-card flex items-center justify-between">
            <div>
              <h3 class="text-base text-gray-500 mb-1">نسبة الإنجاز</h3>
              <p class="text-3xl font-extrabold">${completionRate}%</p>
            </div>
            <div class="text-4xl text-purple-500">
              <i class="ph ph-chart-pie"></i>
            </div>
          </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
          <div class="lg:col-span-2 p-6 rounded-2xl stat-card">
            <h2 class="text-xl font-bold mb-4">أداء النظام خلال الأسبوع</h2>
            <div class="h-60">
              <canvas id="performanceChart"></canvas>
            </div>
          </div>
          
          <div class="p-6 rounded-2xl stat-card">
            <h2 class="text-xl font-bold mb-4">كفاءة الأقسام</h2>
            <div class="h-60">
              <canvas id="departmentsChart"></canvas>
            </div>
          </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
          <div class="p-6 rounded-2xl stat-card">
            <h2 class="text-xl font-bold mb-4">إحصائيات أخرى</h2>
            <div class="space-y-4">
              <div class="flex justify-between items-center text-lg">
                <span class="text-gray-500">متوسط وقت الإنجاز</span>
                <span class="font-bold">${avgCompletionTime} يوم</span>
              </div>
              <div class="flex justify-between items-center text-lg">
                <span class="text-gray-500">عدد الطلبات قيد التنفيذ</span>
                <span class="font-bold">${inProgressTasks}</span>
              </div>
              <div class="flex justify-between items-center text-lg">
                <span class="text-gray-500">عدد الطلبات المنتظرة</span>
                <span class="font-bold">${pendingTasks}</span>
              </div>
              <div class="flex justify-between items-center text-lg">
                <span class="text-gray-500">نسبة الطلبات المتأخرة</span>
                <span class="font-bold">${totalTasks > 0 ? Math.round((overdueTasks.length / totalTasks) * 100) : 0}%</span>
              </div>
            </div>
          </div>
          
          <div class="p-6 rounded-2xl stat-card">
            <h2 class="text-xl font-bold mb-4">توزيع الحالات</h2>
            <div class="h-60">
              <canvas id="statusChart"></canvas>
            </div>
          </div>
          
          <div class="p-6 rounded-2xl stat-card">
            <h2 class="text-xl font-bold mb-4">آخر الأنشطة</h2>
            <div class="space-y-3 max-h-60 overflow-y-auto">
              ${activityLog.slice(0, 5).map(log => `
                <div class="border-r-2 pr-3 border-[var(--primary-orange)]">
                  <p class="text-sm opacity-80">${new Date(log.timestamp).toLocaleString('en-US')}</p>
                  <p class="text-base">${log.taskTitle}: <span class="font-semibold">${log.action}</span></p>
                </div>
              `).join('') || '<div class="text-gray-500 text-center py-6">لا توجد أنشطة حديثة</div>'}
            </div>
          </div>
        </div>
        
        <div class="p-6 rounded-2xl stat-card mb-8">
          <h2 class="text-xl font-bold mb-4">أحدث الطلبات</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            ${tasks.slice(0, 3).map(task => `
              <div class="p-5 rounded-2xl task-card ${darkMode ? 'bg-gray-700' : 'bg-gray-100'} flex flex-col cursor-pointer" onclick="showTaskDetails(${task.id})">
                <div class="absolute top-0 right-0 left-0 h-2 rounded-t-xl" style="background-color: ${priorities[task.priority]?.color || '#999'};"></div>
                <div class="flex justify-between items-start mb-3 mt-2">
                  <span class="px-3 py-1 text-xs font-semibold rounded-full flex items-center gap-1" 
                        style="background:${hexToRgba(departments[task.department]?.color || '#ccc', 0.2)}; color:${departments[task.department]?.color || '#ccc'};">
                    <i class="ph ${departments[task.department]?.icon || 'ph-folder'} text-sm"></i>
                    ${task.department}
                  </span>
                  <span class="px-2 py-1 rounded-full text-xs flex items-center gap-1 font-medium" 
                        style="background:${hexToRgba(statuses[task.status]?.color || '#999', 0.15)}; color:${statuses[task.status]?.color || '#999'}">
                    <i class="ph ${statuses[task.status]?.icon} text-sm"></i>
                    ${task.status}
                  </span>
                </div>
                <h3 class="text-xl font-bold mb-2">${task.title}</h3>
                <p class="text-sm text-gray-500 mb-3">بواسطة: ${task.requester}</p>
                
                <div class="space-y-2 text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}">
                  ${task.size ? `<p><i class="ph ph-rulers text-lg ml-2"></i> المقاس: ${task.size}</p>` : ''}
                  ${task.type ? `<p><i class="ph ph-tag text-lg ml-2"></i> النوع: ${task.type}</p>` : ''}
                  <p><i class="ph ph-calendar-blank text-lg ml-2"></i> التسليم: 
                    <span class="${new Date(task.deadline) < new Date() && task.status !== "منجز" ? 'text-red-500 font-bold' : ''}">${task.deadline ? new Date(task.deadline).toLocaleDateString('en-US') : '--'} ${new Date(task.deadline) < new Date() && task.status !== "منجز" ? '<i class="ph ph-warning text-red-500 ml-1"></i>' : ''}</span>
                  </p>
                  ${task.link ? `<p><i class="ph ph-link text-lg ml-2"></i> <a href="${task.link}" target="_blank" class="text-blue-400 underline hover:text-blue-600 cursor-pointer" onclick="event.stopPropagation()">رابط</a></p>` : ''}
                </div>
                ${task.tags && task.tags.length > 0 ? `
                  <div class="flex flex-wrap gap-1 mt-3">
                    ${task.tags.map(tag => {
                      const tagInfo = tagsOptions.find(t => t.id === tag) || { id: tag, color: "#999" };
                      return `<span class="tag text-xs" style="background-color: ${hexToRgba(tagInfo.color, 0.15)}; color: ${tagInfo.color};">${tag}</span>`;
                    }).join('')}
                  </div>
                ` : ''}
                ${task.assignedTo ? `
                  <div class="flex items-center mt-3 text-sm text-gray-500">
                    <i class="ph ph-user-circle text-lg ml-2"></i>
                    <span>المسؤول:</span>
                    <span class="font-semibold mr-1">${teamMembers.find(t => t.id === task.assignedTo)?.name || 'غير معروف'}</span>
                  </div>
                ` : ''}
                <div class="flex justify-between items-center mt-4 pt-3 border-t border-dashed border-gray-700/30">
                  <span class="text-xs text-gray-500">${new Date(task.createdAt).toLocaleDateString('en-US')}</span>
                  <div class="flex gap-2">
                    <button onclick="editTask(${task.id}); event.stopPropagation();" class="text-blue-500 text-xl hover:text-blue-600 transition">
                      <i class="ph ph-pencil-simple"></i>
                    </button>
                    <button onclick="confirmDeleteTask(${task.id}); event.stopPropagation();" class="text-red-500 text-xl hover:text-red-600 transition">
                      <i class="ph ph-trash-simple"></i>
                    </button>
                  </div>
                </div>
              </div>
            `).join('') || '<div class="text-gray-500 text-center col-span-3 py-6">لا توجد طلبات</div>'}
          </div>
        </div>
      `;
      
      // إنشاء المخططات
      setTimeout(() => {
        createPerformanceChart(last7Days, newTasksPerDay, completedTasksPerDay);
        createDepartmentsChart(departmentCounts);
        createStatusChart(statusCounts);
      }, 100);
    }
    
    // دالة إنشاء بطاقة الطلب (تم نقلها لضمان ترتيب الدوال)
    function renderTaskCard(task, isCompleted = false) {
      const statusColor = statuses[task.status]?.color || "#999";
      const priorityColor = priorities[task.priority]?.color || "#999";
      
      const cardBgColor = darkMode ? 'var(--card-dark)' : 'var(--card-light)';
      const borderHighlightColor = isCompleted ? statuses["منجز"].color : statusColor;

      const opacity = isCompleted ? "opacity-70" : "";
      const textColor = darkMode ? "text-gray-300" : "text-gray-700";

      const deadlineDate = task.deadline ? new Date(task.deadline) : null;
      const today = new Date();
      const isOverdue = deadlineDate && deadlineDate < today && task.status !== "منجز";
      const formattedDeadline = task.deadline ? new Date(task.deadline).toLocaleDateString('en-US') : "--";
      
      const tagsHTML = task.tags && task.tags.length > 0 ? `
        <div class="flex flex-wrap gap-1 mt-3">
          ${task.tags.map(tag => {
            const tagInfo = tagsOptions.find(t => t.id === tag) || { id: tag, color: "#999" };
            return `<span class="tag text-xs" style="background-color: ${hexToRgba(tagInfo.color, 0.15)}; color: ${tagInfo.color};">${tag}</span>`;
          }).join('')}
        </div>
      ` : '';
      
      const assignedHTML = task.assignedTo ? `
        <div class="flex items-center mt-3 text-sm text-gray-500">
          <i class="ph ph-user-circle text-lg ml-2"></i>
          <span>المسؤول:</span>
          <span class="font-semibold mr-1">${teamMembers.find(t => t.id === task.assignedTo)?.name || 'غير معروف'}</span>
        </div>
      ` : '';

      return `
        <div class="task-card p-5 rounded-2xl shadow-md transition ${opacity} cursor-pointer relative" 
             style="background-color: ${cardBgColor}; border: 2px solid ${borderHighlightColor};">
          
          <div class="absolute top-0 right-0 left-0 h-2 rounded-t-xl" style="background-color: ${priorityColor};"></div>

          <div class="flex justify-between items-start mb-3 mt-2">
            <span class="px-3 py-1 text-xs font-semibold rounded-full flex items-center gap-1" 
                  style="background:${hexToRgba(departments[task.department]?.color || '#ccc', 0.2)}; color:${departments[task.department]?.color || '#ccc'};">
              <i class="ph ${departments[task.department]?.icon || 'ph-folder'} text-sm"></i>
              ${task.department || "غير محدد"}
            </span>
            <span class="px-2 py-1 rounded-full text-xs flex items-center gap-1 font-medium" 
                  style="background:${hexToRgba(statuses[task.status]?.color || '#999', 0.15)}; color:${statuses[task.status]?.color || '#999'}">
              <i class="ph ${statuses[task.status]?.icon} text-sm"></i>
              ${task.status}
            </span>
          </div>
          <h2 class="text-xl font-bold mb-2">${task.title || "بدون عنوان"}</h2>
          <p class="text-sm text-gray-500 mb-3">بواسطة: ${task.requester || "--"}</p>
          
          <div class="space-y-2 text-sm ${textColor}">
            ${task.size ? `<p><i class="ph ph-rulers text-lg ml-2"></i> المقاس: ${task.size}</p>` : ''}
            ${task.type ? `<p><i class="ph ph-tag text-lg ml-2"></i> النوع: ${task.type}</p>` : ''}
            <p><i class="ph ph-calendar-blank text-lg ml-2"></i> التسليم: 
              <span class="${isOverdue ? 'text-red-500 font-bold' : ''}">${formattedDeadline} ${isOverdue ? '<i class="ph ph-warning text-red-500 ml-1"></i>' : ''}</span>
            </p>
            ${task.link ? `<p><i class="ph ph-link text-lg ml-2"></i> <a href="${task.link}" target="_blank" class="text-blue-400 underline hover:text-blue-600 cursor-pointer" onclick="event.stopPropagation()">رابط</a></p>` : ''}
          </div>
          ${tagsHTML}
          ${assignedHTML}
          <div class="flex justify-between items-center mt-4 pt-3 border-t border-dashed border-gray-700/30">
            <span class="text-xs text-gray-500">${new Date(task.createdAt).toLocaleDateString('en-US')}</span>
            <div class="flex gap-2">
              <button onclick="editTask(${task.id}); event.stopPropagation();" class="text-blue-500 text-xl hover:text-blue-600 transition">
                <i class="ph ph-pencil-simple"></i>
              </button>
              <button onclick="confirmDeleteTask(${task.id}); event.stopPropagation();" class="text-red-500 text-xl hover:text-red-600 transition">
                <i class="ph ph-trash-simple"></i>
              </button>
            </div>
          </div>
        </div>`;
    }
    
    // دالة تطبيق الفلاتر
    function applyFilters() {
      filteredTasks = tasks.filter(task => {
        // تطبيق البحث
        if (searchTerm && !task.title.toLowerCase().includes(searchTerm.toLowerCase()) && 
            !task.requester.toLowerCase().includes(searchTerm.toLowerCase()) && 
            !(task.description && task.description.toLowerCase().includes(searchTerm.toLowerCase()))) {
          return false;
        }
        
        // تطبيق القسم
        if (currentFilter.department && task.department !== currentFilter.department) {
          return false;
        }
        
        // تطبيق الحالة
        if (currentFilter.status && task.status !== currentFilter.status) {
          return false;
        }
        
        // تطبيق الأولوية
        if (currentFilter.priority && task.priority !== currentFilter.priority) {
          return false;
        }
        
        // تطبيق التاغات
        if (currentFilter.tags.length > 0) {
          if (!task.tags || !currentFilter.tags.some(tag => task.tags.includes(tag))) {
            return false;
          }
        }
        
        return true;
      });
      
      // تطبيق الترتيب
      if (currentSort.field) {
        filteredTasks.sort((a, b) => {
          let valA = a[currentSort.field] || '';
          let valB = b[currentSort.field] || '';
          
          if (currentSort.field === 'deadline') {
            valA = valA ? new Date(valA).getTime() : Infinity;
            valB = valB ? new Date(valB).getTime() : Infinity;
          } else if (currentSort.field === 'createdAt') {
            valA = valA ? new Date(valA).getTime() : 0;
            valB = valB ? new Date(valB).getTime() : 0;
          }
          
          if (valA < valB) return currentSort.ascending ? -1 : 1;
          if (valA > valB) return currentSort.ascending ? 1 : -1;
          return 0;
        });
      }
    }
    
    // دالة عرض تفاصيل الطلب
    function showTaskDetails(id) {
      const task = tasks.find(t => t.id === id);
      if (!task) return;
      
      const taskComments = comments[id] || [];
      
      const taskDetailsContent = document.getElementById('task-details-content');
      
      // حساب الوقت المنقضي منذ إنشاء الطلب
      const created = new Date(task.createdAt);
      const now = new Date();
      const diffTime = Math.abs(now - created);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      // حساب نسبة الإنجاز (وهمي)
      let progressPercentage = 0;
      switch (task.status) {
        case "منجز": progressPercentage = 100; break;
        case "جاري العمل": progressPercentage = 60; break;
        case "انتظار الرد": progressPercentage = 40; break;
        case "انتظار المحتوى": progressPercentage = 30; break;
        case "غير منجز": progressPercentage = 10; break;
        default: progressPercentage = 0;
      }
      
      taskDetailsContent.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="md:col-span-2 space-y-4">
            <div class="flex flex-wrap gap-2 mb-4">
              <span class="px-3 py-1 text-sm rounded-full font-semibold" style="background:${hexToRgba(departments[task.department]?.color || '#ccc', 0.2)}; color:${departments[task.department]?.color || '#ccc'};">
                <i class="ph ${departments[task.department]?.icon || 'ph-folder'} ml-1"></i> ${task.department || "غير محدد"}
              </span>
              <span class="px-3 py-1 text-sm rounded-full font-semibold" style="background:${hexToRgba(statuses[task.status]?.color || '#999', 0.2)}; color:${statuses[task.status]?.color || '#999'}">
                <i class="ph ${statuses[task.status]?.icon} ml-1"></i> ${task.status}
              </span>
              <span class="px-3 py-1 text-sm rounded-full font-semibold" style="background:${hexToRgba(priorities[task.priority]?.color || '#999', 0.2)}; color:${priorities[task.priority]?.color || '#999'}">
                <i class="ph ${priorities[task.priority]?.icon} ml-1"></i> ${task.priority}
              </span>
            </div>
            
            <h1 class="text-3xl font-bold mb-4">${task.title}</h1>
            
            ${task.description ? `
              <div class="p-4 rounded-lg bg-gray-700/30 text-base">
                <h3 class="font-bold mb-2 text-lg">وصف الطلب:</h3>
                <p>${task.description}</p>
              </div>
            ` : ''}
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 text-base">
              <div class="space-y-2">
                <p><span class="text-gray-500 ml-2"><i class="ph ph-user-circle text-xl align-middle"></i></span> <span class="font-semibold">${task.requester}</span></p>
                <p><span class="text-gray-500 ml-2"><i class="ph ph-calendar-check text-xl align-middle"></i></span> تاريخ الإنشاء: <span class="font-semibold">${new Date(task.createdAt).toLocaleString('en-US')}</span></p>
                <p><span class="text-gray-500 ml-2"><i class="ph ph-timer text-xl align-middle"></i></span> منذ: <span class="font-semibold">${diffDays} يوم</span></p>
                ${task.type ? `<p><span class="text-gray-500 ml-2"><i class="ph ph-tag text-xl align-middle"></i></span> النوع: <span class="font-semibold">${task.type}</span></p>` : ''}
              </div>
              <div class="space-y-2">
                <p><span class="text-gray-500 ml-2"><i class="ph ph-rulers text-xl align-middle"></i></span> المقاس: <span class="font-semibold">${task.size || "غير محدد"}</span></p>
                <p><span class="text-gray-500 ml-2"><i class="ph ph-calendar-blank text-xl align-middle"></i></span> الموعد النهائي: <span class="font-semibold">${task.deadline ? new Date(task.deadline).toLocaleDateString('en-US') : "غير محدد"}</span></p>
                ${task.link ? `<p><span class="text-gray-500 ml-2"><i class="ph ph-link text-xl align-middle"></i></span> الرابط: <a href="${task.link}" target="_blank" class="text-blue-400 underline hover:text-blue-600">فتح الرابط</a></p>` : ''}
                ${task.completedAt ? `<p><span class="text-gray-500 ml-2"><i class="ph ph-check-circle text-xl align-middle"></i></span> تاريخ الإنجاز: <span class="font-semibold">${new Date(task.completedAt).toLocaleString('en-US')}</span></p>` : ''}
              </div>
            </div>
            
            <div class="mt-4">
              <p class="text-gray-500 mb-2 text-base">نسبة الإنجاز:</p>
              <div class="progress-bar">
                <div class="progress-bar-fill" style="width: ${progressPercentage}%"></div>
              </div>
              <p class="text-sm text-left mt-1 font-semibold">${progressPercentage}%</p>
            </div>
            
            ${task.tags && task.tags.length > 0 ? `
              <div class="mt-4">
                <p class="text-gray-500 mb-2 text-base">العلامات:</p>
                <div class="flex flex-wrap gap-2">
                  ${task.tags.map(tag => {
                    const tagInfo = tagsOptions.find(t => t.id === tag) || { id: tag, color: "#999" };
                    return `<span class="tag" style="background-color: ${hexToRgba(tagInfo.color, 0.2)}; color: ${tagInfo.color};">${tag}</span>`;
                  }).join('')}
                </div>
              </div>
            ` : ''}
            
            <div class="flex flex-wrap gap-4 mt-6">
              <button onclick="editTask(${task.id})" class="px-5 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition flex items-center gap-2 text-base">
                <i class="ph ph-pencil-simple text-xl"></i>
                تعديل الطلب
              </button>
              <button onclick="duplicateTask(${task.id})" class="px-5 py-3 rounded-lg bg-purple-600 text-white hover:bg-purple-700 transition flex items-center gap-2 text-base">
                <i class="ph ph-copy text-xl"></i>
                نسخ الطلب
              </button>
              <button onclick="confirmDeleteTask(${task.id})" class="px-5 py-3 rounded-lg bg-red-600 text-white hover:bg-red-700 transition flex items-center gap-2 text-base">
                <i class="ph ph-trash-simple text-xl"></i>
                حذف الطلب
              </button>
            </div>
          </div>
          
          <div class="space-y-4">
            <h2 class="text-xl font-bold mb-3">التعليقات والملاحظات</h2>
            
            <div class="max-h-96 overflow-y-auto space-y-4 p-2 custom-scrollbar">
              ${taskComments.length > 0 ? 
                taskComments.map(comment => `
                  <div class="comment rounded-xl p-4 border border-transparent" style="border-color: ${darkMode ? 'var(--border-dark)' : 'var(--border-light)'};">
                    <div class="flex justify-between items-start mb-2">
                      <div class="flex items-center gap-2">
                        <div class="w-9 h-9 rounded-full flex items-center justify-center bg-blue-600 text-white font-bold text-sm">
                          ${comment.user.charAt(0)}
                        </div>
                        <span class="font-bold text-base">${comment.user}</span>
                      </div>
                      <span class="text-xs text-gray-500">${new Date(comment.timestamp).toLocaleString('ar-SA')}</span>
                    </div>
                    <p class="text-base">${comment.text}</p>
                  </div>
                `).join('') 
                : '<p class="text-gray-500 text-center py-6">لا توجد تعليقات</p>'
              }
            </div>
            
            <div>
              <textarea id="comment-text" rows="4" class="p-3 rounded-xl w-full resize-none" placeholder="أضف تعليقًا..."></textarea>
              <button onclick="addComment(${task.id})" class="mt-2 px-5 py-3 btn-primary rounded-xl transition w-full flex items-center justify-center gap-2 text-base">
                <i class="ph ph-plus text-xl"></i> إضافة تعليق
              </button>
            </div>
            
            <div class="mt-6">
              <h3 class="font-bold mb-3 text-lg">تغيير الحالة:</h3>
              <div class="grid grid-cols-2 gap-2">
                ${Object.keys(statuses).map(status => `
                  <button onclick="updateStatus(${task.id}, '${status}')" 
                      class="px-4 py-2 rounded-lg flex items-center justify-center gap-1 text-sm font-medium transition-all border-2 border-transparent"
                      style="background: ${hexToRgba(statuses[status].color, 0.1)}; color: ${statuses[status].color}; ${task.status === status ? 'border-color: ' + statuses[status].color + '; background-color: ' + hexToRgba(statuses[status].color, 0.2) : ''}">
                      <i class="ph ${statuses[status].icon} text-base"></i>
                      ${status}
                  </button>
                `).join('')}
              </div>
            </div>
            
            <div class="mt-4">
              <h3 class="font-bold mb-3 text-lg">تعيين إلى:</h3>
              <div class="grid grid-cols-2 gap-2">
                ${teamMembers.map(member => `
                  <button onclick="assignTask(${task.id}, ${member.id})" 
                      class="px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium transition-all border-2 border-transparent" 
                      style="background: ${darkMode ? 'var(--card-dark)' : 'var(--bg-light)'}; ${task.assignedTo === member.id ? 'border-color: #3498db; background-color: ' + hexToRgba('#3498db', 0.1) : ''}">
                      <div class="w-8 h-8 rounded-full flex items-center justify-center bg-blue-600 text-white font-bold text-sm">
                        ${member.avatar}
                      </div>
                      ${member.name}
                  </button>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
      
      // إظهار المودال
      document.getElementById('task-details-modal').classList.add('show');
    }
    
    // دالة إضافة تعليق
    function addComment(taskId) {
      const commentText = document.getElementById('comment-text').value.trim();
      if (!commentText) {
        showNotification('يرجى كتابة التعليق قبل الإضافة', 'error');
        return;
      }
      
      // إنشاء التعليق
      const newComment = {
        id: Date.now(),
        taskId: taskId,
        user: 'المستخدم الحالي', // قابل للتغيير مع نظام المستخدمين
        timestamp: new Date().toISOString(),
        text: commentText
      };
      
      // إضافة التعليق للمهمة
      if (!comments[taskId]) {
        comments[taskId] = [];
      }
      comments[taskId].push(newComment);
      
      // حفظ التعليقات
      localStorage.setItem('comments', JSON.stringify(comments));
      
      // تسجيل النشاط
      logActivity('إضافة تعليق', taskId, commentText.substring(0, 30) + (commentText.length > 30 ? '...' : ''));
      
      // تحديث واجهة المستخدم
      showTaskDetails(taskId);
      showNotification('تم إضافة التعليق بنجاح');
    }
    
    // دالة تعيين المهمة لشخص
    function assignTask(taskId, userId) {
      const taskIndex = tasks.findIndex(t => t.id === taskId);
      if (taskIndex === -1) return;
      
      const member = teamMembers.find(m => m.id === userId);
      if (!member) return;
      
      // تحديث المهمة
      tasks[taskIndex].assignedTo = userId;
      
      // حفظ التغييرات
      localStorage.setItem('tasks', JSON.stringify(tasks));
      
      // تسجيل النشاط
      logActivity('تعيين مسؤول', taskId, `تم تعيين المهمة إلى ${member.name}`);
      
      // تحديث واجهة المستخدم
      showTaskDetails(taskId);
      showNotification(`تم تعيين الطلب إلى ${member.name} بنجاح`);
    }
    
    // دالة تحديث حالة المهمة
    function updateStatus(id, status) {
      const taskIndex = tasks.findIndex(t => t.id === id);
      if (taskIndex === -1) return;
      
      const oldStatus = tasks[taskIndex].status;
      tasks[taskIndex].status = status;
      
      // إذا تم تغيير الحالة إلى منجز، نضيف تاريخ الإنجاز
      if (status === "منجز" && oldStatus !== "منجز") {
        tasks[taskIndex].completedAt = new Date().toISOString();
      } else if (status !== "منجز") {
        // إذا تغيرت من منجز إلى غير منجز، نحذف تاريخ الإنجاز
        delete tasks[taskIndex].completedAt;
      }
      
      // حفظ التغييرات
      localStorage.setItem("tasks", JSON.stringify(tasks));
      
      // تسجيل النشاط
      logActivity(status, id, `تم تغيير الحالة من ${oldStatus} إلى ${status}`);
      
      // تحديث الواجهة
      updateUI();
      
      // إذا كان في المودال، نحدثه
      if (document.getElementById('task-details-modal').classList.contains('show')) {
        showTaskDetails(id);
      }
      
      showNotification(`تم تحديث حالة الطلب إلى: ${status}`);
    }
    
    // دالة إنشاء قسم الطلبات
    function renderTasks() {
      // تطبيق الفلاتر
      applyFilters();
      
      const activeTasks = filteredTasks.filter(t => t.status !== "منجز");
      const doneTasks = filteredTasks.filter(t => t.status === "منجز");
      
      const app = document.getElementById("app");
      app.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h1 class="text-3xl font-bold">إدارة الطلبات</h1>
          <div class="flex gap-4">
            <button onclick="toggleMode()" class="px-5 py-2 rounded-full btn-primary flex items-center gap-2">
              <i class="ph ${darkMode ? 'ph-sun' : 'ph-moon'}"></i>
              ${darkMode ? "الوضع النهاري" : "الوضع الليلي"}
            </button>
            <button onclick="exportTasks()" class="px-5 py-2 rounded-full btn-secondary flex items-center gap-2">
              <i class="ph ph-download"></i>
              تصدير
            </button>
          </div>
        </div>

        <div class="p-6 rounded-2xl stat-card mb-8">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            <div class="flex-1 min-w-40">
              <label for="search" class="text-sm text-gray-500 mb-1 block">بحث</label>
              <div class="search-container relative">
                <input id="search" type="text" placeholder="ابحث عن طلب..." class="p-3 rounded-xl w-full" oninput="handleSearch(this.value)" />
                <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-xl"></i>
                <div class="search-results"></div>
              </div>
            </div>
            <div class="flex-1 min-w-40">
              <label for="department-filter" class="text-sm text-gray-500 mb-1 block">القسم</label>
              <select id="department-filter" class="p-3 rounded-xl w-full" onchange="filterByDepartment(this.value)">
                <option value="">كل الأقسام</option>
                ${Object.keys(departments).map(dep => `<option>${dep}</option>`).join('')}
              </select>
            </div>
            <div class="flex-1 min-w-40">
              <label for="status-filter" class="text-sm text-gray-500 mb-1 block">الحالة</label>
              <select id="status-filter" class="p-3 rounded-xl w-full" onchange="filterByStatus(this.value)">
                <option value="">كل الحالات</option>
                ${Object.keys(statuses).map(s => `<option>${s}</option>`).join('')}
              </select>
            </div>
            <div class="flex-1 min-w-40">
              <label for="priority-filter" class="text-sm text-gray-500 mb-1 block">الأولوية</label>
              <select id="priority-filter" class="p-3 rounded-xl w-full" onchange="filterByPriority(this.value)">
                <option value="">كل الأولويات</option>
                ${Object.keys(priorities).map(p => `<option>${p}</option>`).join('')}
              </select>
            </div>
            <div class="flex-1 min-w-40">
              <label for="sort-by" class="text-sm text-gray-500 mb-1 block">ترتيب</label>
              <select id="sort-by" class="p-3 rounded-xl w-full" onchange="sortBy(this.value)">
                <option value="">بدون ترتيب</option>
                <option value="deadline">موعد التسليم</option>
                <option value="title">العنوان</option>
                <option value="priority">الأولوية</option>
                <option value="department">القسم</option>
                <option value="createdAt">تاريخ الإنشاء</option>
              </select>
            </div>
            <div class="flex-1 min-w-40 col-span-full md:col-span-2 lg:col-span-3 xl:col-span-4">
                <label class="text-sm text-gray-500 mb-1 block">العلامات (التاغات)</label>
                <div class="flex flex-wrap gap-2 mt-1" id="filter-tags-container">
                  ${tagsOptions.map(tag => `
                    <label class="tag cursor-pointer" style="background-color: ${hexToRgba(tag.color, 0.2)}; color: ${tag.color};">
                      <input type="checkbox" class="filter-tag-checkbox ml-1" value="${tag.id}" onchange="filterByTag(this.value, this.checked)"> ${tag.id}
                    </label>
                  `).join('')}
                </div>
            </div>
          </div>
          <div class="flex justify-end mt-4">
            <button onclick="resetFilters()" class="px-5 py-2 rounded-lg btn-secondary flex items-center gap-2">
              <i class="ph ph-x"></i>
              إعادة تعيين الفلاتر
            </button>
          </div>
        </div>

        <div class="mb-10">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">الطلبات النشطة</h2>
            <p class="text-sm text-gray-500">${activeTasks.length} طلب</p>
          </div>
          ${activeTasks.length > 0 ? `
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-10">
              ${activeTasks.map(t => renderTaskCard(t)).join('')}
            </div>
          ` : '<div class="p-10 text-center text-gray-500 border border-dashed rounded-lg bg-gray-700/20">لا توجد طلبات نشطة</div>'}
        </div>

        <div>
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">الطلبات المنجزة</h2>
            <p class="text-sm text-gray-500">${doneTasks.length} طلب</p>
          </div>
          ${doneTasks.length > 0 ? `
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
              ${doneTasks.map(t => renderTaskCard(t, true)).join('')}
            </div>
          ` : '<div class="p-10 text-center text-gray-500 border border-dashed rounded-lg bg-gray-700/20">لا توجد طلبات منجزة</div>'}
        </div>
      `;
      
      // تحديث حالة الفلاتر الحالية في واجهة المستخدم
      if (currentFilter.department) {
        document.getElementById('department-filter').value = currentFilter.department;
      }
      if (currentFilter.status) {
        document.getElementById('status-filter').value = currentFilter.status;
      }
      if (currentFilter.priority) {
        document.getElementById('priority-filter').value = currentFilter.priority;
      }
      if (currentSort.field) {
        document.getElementById('sort-by').value = currentSort.field;
      }
      if (searchTerm) {
        document.getElementById('search').value = searchTerm;
      }
      // تحديث حالة التاغات
      if (currentFilter.tags.length > 0) {
        document.querySelectorAll('.filter-tag-checkbox').forEach(checkbox => {
          if (currentFilter.tags.includes(checkbox.value)) {
            checkbox.checked = true;
          }
        });
      }
    }
    
    // دالة إنشاء مخطط الأداء
    function createPerformanceChart(labels, newTasksData, completedTasksData) {
      const ctx = document.getElementById('performanceChart')?.getContext('2d');
      if (!ctx) return;
      
      // ترجمة التواريخ
      const arabicLabels = labels.map(date => {
        return moment(date).locale('ar').format('ddd DD MMM');
      });
      
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: arabicLabels,
          datasets: [
            {
              label: 'طلبات جديدة',
              data: newTasksData,
              borderColor: '#3498db',
              backgroundColor: 'rgba(52, 152, 219, 0.1)',
              borderWidth: 2,
              tension: 0.3,
              fill: true
            },
            {
              label: 'طلبات منجزة',
              data: completedTasksData,
              borderColor: '#2ecc71',
              backgroundColor: 'rgba(46, 204, 113, 0.1)',
              borderWidth: 2,
              tension: 0.3,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                color: darkMode ? '#fff' : '#000'
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
              },
              ticks: {
                color: darkMode ? '#fff' : '#000'
              }
            },
            x: {
              grid: {
                color: darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
              },
              ticks: {
                color: darkMode ? '#fff' : '#000'
              }
            }
          }
        }
      });
    }
    
    // دالة إنشاء مخطط الأقسام
    function createDepartmentsChart(departmentCounts) {
      const ctx = document.getElementById('departmentsChart')?.getContext('2d');
      if (!ctx) return;
      
      const deptLabels = Object.keys(departmentCounts);
      const deptData = Object.values(departmentCounts);
      const deptColors = deptLabels.map(dept => departments[dept]?.color || '#ccc');
      
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: deptLabels,
          datasets: [{
            data: deptData,
            backgroundColor: deptColors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: darkMode ? '#fff' : '#000',
                font: {
                  size: 10
                }
              }
            }
          }
        }
      });
    }
    
    // دالة إنشاء مخطط الحالات
    function createStatusChart(statusCounts) {
      const ctx = document.getElementById('statusChart')?.getContext('2d');
      if (!ctx) return;
      
      const statusLabels = Object.keys(statusCounts);
      const statusData = Object.values(statusCounts);
      const statusColors = statusLabels.map(status => statuses[status]?.color || '#ccc');
      
      new Chart(ctx, {
        type: 'polarArea',
        data: {
          labels: statusLabels,
          datasets: [{
            data: statusData,
            backgroundColor: statusColors.map(color => hexToRgba(color, 0.7)),
            borderColor: statusColors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: darkMode ? '#fff' : '#000',
                font: {
                  size: 10
                }
              }
            }
          }
        }
      });
    }
    
    // دالة إنشاء قسم التقارير
    function renderReports() {
      const app = document.getElementById("app");
      app.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h1 class="text-3xl font-bold">التقارير والإحصائيات</h1>
          <div class="flex gap-4">
            <button onclick="toggleMode()" class="px-5 py-2 rounded-full btn-primary flex items-center gap-2">
              <i class="ph ${darkMode ? 'ph-sun' : 'ph-moon'}"></i>
              ${darkMode ? "الوضع النهاري" : "الوضع الليلي"}
            </button>
            <button onclick="exportReport()" class="px-5 py-2 rounded-full bg-blue-600 text-white hover:bg-blue-700 transition-all flex items-center gap-2">
              <i class="ph ph-file-pdf"></i>
              تصدير التقرير
            </button>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="stat-card flex items-center justify-between">
            <div>
              <h3 class="text-base text-gray-500 mb-1">إجمالي الطلبات</h3>
              <p class="text-3xl font-extrabold">${tasks.length}</p>
            </div>
            <div class="text-4xl text-blue-500">
              <i class="ph ph-clipboard-text"></i>
            </div>
          </div>
          <div class="stat-card flex items-center justify-between">
            <div>
              <h3 class="text-base text-gray-500 mb-1">الطلبات المنجزة</h3>
              <p class="text-3xl font-extrabold">${tasks.filter(t => t.status === "منجز").length}</p>
            </div>
            <div class="text-4xl text-green-500">
              <i class="ph ph-check-circle"></i>
            </div>
          </div>
          <div class="stat-card flex items-center justify-between">
            <div>
              <h3 class="text-base text-gray-500 mb-1">الطلبات المتأخرة</h3>
              <p class="text-3xl font-extrabold">${tasks.filter(t => {
                  if (!t.deadline || t.status === "منجز" || t.status === "ملغي") return false;
                  return new Date(t.deadline) < new Date();
                }).length}</p>
            </div>
            <div class="text-4xl text-red-500">
              <i class="ph ph-clock-countdown"></i>
            </div>
          </div>
          <div class="stat-card flex items-center justify-between">
            <div>
              <h3 class="text-base text-gray-500 mb-1">نسبة الإنجاز</h3>
              <p class="text-3xl font-extrabold">${tasks.length > 0 ? Math.round((tasks.filter(t => t.status === "منجز").length / tasks.length) * 100) : 0}%</p>
            </div>
            <div class="text-4xl text-purple-500">
              <i class="ph ph-chart-pie"></i>
            </div>
          </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          <div class="p-6 rounded-2xl stat-card">
            <h2 class="text-xl font-bold mb-4">توزيع الطلبات حسب القسم</h2>
            <div class="h-60">
              <canvas id="reportDepartmentsChart"></canvas>
            </div>
          </div>
          
          <div class="p-6 rounded-2xl stat-card">
            <h2 class="text-xl font-bold mb-4">توزيع الطلبات حسب الحالة</h2>
            <div class="h-60">
              <canvas id="reportStatusChart"></canvas>
            </div>
          </div>
        </div>
        
        <div class="p-6 rounded-2xl stat-card mb-8">
          <h2 class="text-xl font-bold mb-4">سجل الأنشطة</h2>
          <div class="overflow-x-auto rounded-lg border border-[var(--border-light)]">
            <table class="w-full text-base">
              <thead>
                <tr class="text-gray-500">
                  <th class="px-4 py-3 text-right">التاريخ</th>
                  <th class="px-4 py-3 text-right">الطلب</th>
                  <th class="px-4 py-3 text-right">النشاط</th>
                  <th class="px-4 py-3 text-right">التفاصيل</th>
                  <th class="px-4 py-3 text-right">المستخدم</th>
                </tr>
              </thead>
              <tbody>
                ${activityLog.slice(0, 20).map(log => `
                  <tr class="hover:bg-gray-100">
                    <td class="px-4 py-2 text-sm text-gray-500">${new Date(log.timestamp).toLocaleString('ar-SA')}</td>
                    <td class="px-4 py-2 font-medium">${log.taskTitle}</td>
                    <td class="px-4 py-2">
                      <span class="px-2 py-1 rounded-full text-xs font-semibold" style="background: ${hexToRgba(statuses[log.action]?.color || '#999', 0.15)}; color: ${statuses[log.action]?.color || '#999'}">
                        ${log.action}
                      </span>
                    </td>
                    <td class="px-4 py-2 text-gray-600">${log.details || '-'}</td>
                    <td class="px-4 py-2 text-gray-500">${log.user}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="p-6 rounded-2xl stat-card mb-8">
          <h2 class="text-xl font-bold mb-4">الطلبات المتأخرة</h2>
          <div class="overflow-x-auto rounded-lg border border-[var(--border-light)]">
            <table class="w-full text-base">
              <thead>
                <tr class="text-gray-500">
                  <th class="px-4 py-3 text-right">العنوان</th>
                  <th class="px-4 py-3 text-right">القسم</th>
                  <th class="px-4 py-3 text-right">الموعد النهائي</th>
                  <th class="px-4 py-3 text-right">التأخير (بالأيام)</th>
                  <th class="px-4 py-3 text-right">الحالة</th>
                  <th class="px-4 py-3 text-right">صاحب الطلب</th>
                </tr>
              </thead>
              <tbody>
                ${tasks.filter(t => {
                  if (!t.deadline || t.status === "منجز" || t.status === "ملغي") return false;
                  return new Date(t.deadline) < new Date();
                }).map(task => {
                  const deadline = new Date(task.deadline);
                  const now = new Date();
                  const diffTime = Math.abs(now - deadline);
                  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                  
                  return `
                    <tr class="hover:bg-gray-100 cursor-pointer" onclick="showTaskDetails(${task.id})">
                      <td class="px-4 py-2 font-bold">${task.title}</td>
                      <td class="px-4 py-2">
                        <span class="px-2 py-1 rounded-full text-xs font-semibold" style="background: ${hexToRgba(departments[task.department]?.color || '#ccc', 0.15)}; color: ${departments[task.department]?.color || '#ccc'}">
                          ${task.department}
                        </span>
                      </td>
                      <td class="px-4 py-2 text-sm text-gray-600">${new Date(task.deadline).toLocaleDateString('ar-SA')}</td>
                      <td class="px-4 py-2 font-bold text-red-500">${diffDays} يوم</td>
                      <td class="px-4 py-2">
                        <span class="px-2 py-1 rounded-full text-xs font-semibold" style="background: ${hexToRgba(statuses[task.status]?.color || '#999', 0.15)}; color: ${statuses[task.status]?.color || '#999'}">
                          ${task.status}
                        </span>
                      </td>
                      <td class="px-4 py-2 text-gray-600">${task.requester}</td>
                    </tr>
                  `;
                }).join('') || `
                  <tr>
                    <td colspan="6" class="px-4 py-8 text-center text-gray-500">لا توجد طلبات متأخرة</td>
                  </tr>
                `}
              </tbody>
            </table>
          </div>
        </div>
      `;
      
      // إنشاء المخططات
      setTimeout(() => {
        // حساب الطلبات حسب القسم
        const departmentCounts = {};
        Object.keys(departments).forEach(dept => {
          departmentCounts[dept] = tasks.filter(t => t.department === dept).length;
        });
        
        // حساب الطلبات حسب الحالة
        const statusCounts = {};
        Object.keys(statuses).forEach(status => {
          statusCounts[status] = tasks.filter(t => t.status === status).length;
        });
        
        createReportDepartmentsChart(departmentCounts);
        createReportStatusChart(statusCounts);
      }, 100);
    }
    
    // دالة إنشاء مخطط التقارير للأقسام
    function createReportDepartmentsChart(departmentCounts) {
      const ctx = document.getElementById('reportDepartmentsChart')?.getContext('2d');
      if (!ctx) return;
      
      const deptLabels = Object.keys(departmentCounts);
      const deptData = Object.values(departmentCounts);
      const deptColors = deptLabels.map(dept => departments[dept]?.color || '#ccc');
      
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: deptLabels,
          datasets: [{
            label: 'عدد الطلبات',
            data: deptData,
            backgroundColor: deptColors.map(color => hexToRgba(color, 0.7)),
            borderColor: deptColors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              ticks: {
                color: darkMode ? '#fff' : '#000'
              },
              grid: {
                color: darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
              }
            },
            x: {
              ticks: {
                color: darkMode ? '#fff' : '#000'
              },
              grid: {
                color: darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
              }
            }
          }
        }
      });
    }
    
    // دالة إنشاء مخطط التقارير للحالات
    function createReportStatusChart(statusCounts) {
      const ctx = document.getElementById('reportStatusChart')?.getContext('2d');
      if (!ctx) return;
      
      const statusLabels = Object.keys(statusCounts);
      const statusData = Object.values(statusCounts);
      const statusColors = statusLabels.map(status => statuses[status]?.color || '#ccc');
      
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: statusLabels,
          datasets: [{
            data: statusData,
            backgroundColor: statusColors.map(color => hexToRgba(color, 0.7)),
            borderColor: statusColors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: darkMode ? '#fff' : '#000'
              }
            }
          }
        }
      });
    }
    
    // دالة إنشاء قسم الإعدادات
    function renderSettings() {
      const app = document.getElementById("app");
      app.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <h1 class="text-3xl font-bold">الإعدادات</h1>
          <div>
            <button onclick="toggleMode()" class="px-5 py-2 rounded-full btn-primary flex items-center gap-2">
              <i class="ph ${darkMode ? 'ph-sun' : 'ph-moon'}"></i>
              ${darkMode ? "الوضع النهاري" : "الوضع الليلي"}
            </button>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div class="p-6 rounded-2xl stat-card">
            <h2 class="text-xl font-bold mb-4">المظهر</h2>
            <div class="space-y-4">
              <div>
                <label class="flex items-center gap-2 cursor-pointer text-lg">
                  <input type="radio" name="theme" value="dark" class="w-5 h-5" ${darkMode ? 'checked' : ''} onchange="setDarkMode(true)">
                  <span>الوضع الداكن</span>
                </label>
              </div>
              <div>
                <label class="flex items-center gap-2 cursor-pointer text-lg">
                  <input type="radio" name="theme" value="light" class="w-5 h-5" ${!darkMode ? 'checked' : ''} onchange="setDarkMode(false)">
                  <span>الوضع الفاتح</span>
                </label>
              </div>
            </div>
          </div>
          
          <div class="p-6 rounded-2xl stat-card">
            <h2 class="text-xl font-bold mb-4">الإشعارات</h2>
            <div class="space-y-4">
              <div>
                <label class="flex items-center gap-2 cursor-pointer text-lg">
                  <input type="checkbox" id="notification-enabled" class="w-5 h-5" checked>
                  <span>تفعيل الإشعارات</span>
                </label>
              </div>
              <div>
                <label class="flex items-center gap-2 cursor-pointer text-lg">
                  <input type="checkbox" id="notification-sound" class="w-5 h-5" checked>
                  <span>صوت الإشعارات</span>
                </label>
              </div>
            </div>
          </div>
          
          <div class="p-6 rounded-2xl stat-card">
            <h2 class="text-xl font-bold mb-4">المستخدم</h2>
            <div class="space-y-4">
              <div>
                <label class="text-sm text-gray-500 mb-1 block">اسم المستخدم</label>
                <input type="text" class="p-3 rounded-xl w-full" value="المستخدم الحالي">
              </div>
              <div>
                <label class="text-sm text-gray-500 mb-1 block">البريد الإلكتروني</label>
                <input type="email" class="p-3 rounded-xl w-full" value="user@example.com">
              </div>
            </div>
          </div>
          
          <div class="p-6 rounded-2xl stat-card col-span-full">
            <h2 class="text-xl font-bold mb-4">النسخ الاحتياطي واستعادة البيانات</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <button onclick="exportData()" class="p-3 rounded-lg btn-secondary hover:bg-gray-600 transition w-full flex items-center justify-center gap-2 text-base">
                  <i class="ph ph-download text-xl"></i>
                  تصدير جميع البيانات
                </button>
              </div>
              <div>
                <div class="relative">
                  <input type="file" id="import-file" accept=".json" class="absolute inset-0 opacity-0 cursor-pointer" onchange="importData(event)">
                  <button class="p-3 rounded-lg btn-secondary hover:bg-gray-600 transition w-full flex items-center justify-center gap-2 text-base">
                    <i class="ph ph-upload text-xl"></i>
                    استيراد البيانات
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="p-6 rounded-2xl stat-card col-span-full">
            <h2 class="text-xl font-bold mb-4 text-red-500">خيارات متقدمة</h2>
            <p class="text-gray-500 mb-4 text-base">تحذير: هذه الخيارات ستؤدي إلى حذف البيانات نهائياً ولا يمكن التراجع عنها.</p>
            <div class="flex flex-wrap gap-4">
              <button onclick="clearTasks()" class="p-3 rounded-lg bg-red-600 text-white hover:bg-red-700 transition flex items-center gap-2 text-base">
                <i class="ph ph-trash text-xl"></i>
                حذف جميع الطلبات
              </button>
              <button onclick="clearComments()" class="p-3 rounded-lg bg-red-600 text-white hover:bg-red-700 transition flex items-center gap-2 text-base">
                <i class="ph ph-chats text-xl"></i>
                حذف جميع التعليقات
              </button>
              <button onclick="clearActivityLog()" class="p-3 rounded-lg bg-red-600 text-white hover:bg-red-700 transition flex items-center gap-2 text-base">
                <i class="ph ph-clock text-xl"></i>
                حذف سجل الأنشطة
              </button>
              <button onclick="resetAll()" class="p-3 rounded-lg bg-red-800 text-white hover:bg-red-900 transition flex items-center gap-2 text-base">
                <i class="ph ph-prohibit text-xl"></i>
                إعادة تعيين النظام بالكامل
              </button>
            </div>
          </div>
        </div>
      `;
    }
    
    // دالة تصفية المهام حسب القسم
    function filterByDepartment(value) {
      currentFilter.department = value || null;
      updateUI();
    }
    
    // دالة تصفية المهام حسب الحالة
    function filterByStatus(value) {
      currentFilter.status = value || null;
      updateUI();
    }
    
    // دالة تصفية المهام حسب الأولوية
    function filterByPriority(value) {
      currentFilter.priority = value || null;
      updateUI();
    }

    // دالة تصفية المهام حسب التاغ
    function filterByTag(tagValue, isChecked) {
      if (isChecked) {
        if (!currentFilter.tags.includes(tagValue)) {
          currentFilter.tags.push(tagValue);
        }
      } else {
        currentFilter.tags = currentFilter.tags.filter(tag => tag !== tagValue);
      }
      updateUI();
    }
    
    // دالة البحث
    function handleSearch(value) {
      searchTerm = value;
      updateUI();
    }
    
    // دالة ترتيب المهام
    function sortBy(value) {
      if (!value) {
        currentSort = { field: null, ascending: true };
      } else if (currentSort.field === value) {
        currentSort.ascending = !currentSort.ascending;
      } else {
        currentSort = { field: value, ascending: true };
      }
      updateUI();
    }
    
    // دالة إعادة تعيين الفلاتر
    function resetFilters() {
      currentFilter = { department: null, status: null, priority: null, tags: [] };
      searchTerm = '';
      currentSort = { field: null, ascending: true };
      updateUI();
      // تأكد من إلغاء تحديد مربعات التحديد للتاغات
      document.querySelectorAll('.filter-tag-checkbox').forEach(checkbox => {
        checkbox.checked = false;
      });
      showNotification('تم إعادة تعيين الفلاتر');
    }
    
    // دالة فتح مودال إضافة/تعديل طلب
    function openTaskModal() {
      const modalTitle = document.getElementById('modal-title');
      const taskForm = document.getElementById('task-form');
      
      modalTitle.textContent = editId ? 'تعديل الطلب' : 'إضافة طلب جديد';
      
      // إعداد حقول النموذج
      const formFields = [
        { id: "title", label: "عنوان الطلب", required: true },
        { id: "requester", label: "اسم صاحب الطلب", required: true },
        { id: "type", label: "نوع الطلب" },
        { id: "size", label: "مقاس التصميم" },
        { id: "link", label: "الرابط", type: "url" },
        { id: "deadline", label: "تاريخ التسليم", type: "date" }
      ];
      
      // إنشاء النموذج
      taskForm.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          ${formFields.map(f => `
            <div class="flex flex-col">
              <label for="${f.id}" class="text-sm text-gray-500 mb-1">${f.label} ${f.required ? '<span class="text-red-500">*</span>' : ''}</label>
              <input id="${f.id}" type="${f.type || 'text'}" class="p-3 rounded-xl w-full" ${f.required ? 'required' : ''} />
            </div>
          `).join('')}
          
          <div class="flex flex-col">
            <label for="department" class="text-sm text-gray-500 mb-1">القسم</label>
            <select id="department" class="p-3 rounded-xl w-full">
              ${Object.keys(departments).map(dep => `<option>${dep}</option>`).join('')}
            </select>
          </div>
          
          <div class="flex flex-col">
            <label for="priority" class="text-sm text-gray-500 mb-1">الأولوية</label>
            <select id="priority" class="p-3 rounded-xl w-full">
              ${Object.keys(priorities).map(p => `<option>${p}</option>`).join('')}
            </select>
          </div>
          
          <div class="flex flex-col col-span-full">
            <label for="description" class="text-sm text-gray-500 mb-1">تفاصيل الطلب</label>
            <textarea id="description" rows="4" class="p-3 rounded-xl w-full resize-none"></textarea>
          </div>
          
          <div class="flex flex-col col-span-full">
            <label class="text-sm text-gray-500 mb-1">العلامات (التاغات)</label>
            <div class="flex flex-wrap gap-2 mt-1">
              ${tagsOptions.map(tag => `
                <label class="tag cursor-pointer" style="background-color: ${hexToRgba(tag.color, 0.15)}; color: ${tag.color};">
                  <input type="checkbox" class="tag-checkbox ml-1" value="${tag.id}"> ${tag.id}
                </label>
              `).join('')}
            </div>
          </div>
        </div>
        
        <div class="flex gap-4 mt-6">
          <button onclick="saveTask()" class="flex-1 btn-primary py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2">
            <i class="ph ${editId ? 'ph-pencil-simple' : 'ph-plus'} text-xl"></i>
            ${editId ? "تحديث الطلب" : "إضافة الطلب"}
          </button>
          ${editId ? `
            <button onclick="cancelEdit()" class="flex-1 bg-gray-600 py-3 rounded-xl text-white font-bold hover:bg-gray-700 transition-all flex items-center justify-center gap-2">
              <i class="ph ph-x text-xl"></i>
              إلغاء التعديل
            </button>
          ` : ''}
        </div>
      `;
      
      // تعبئة البيانات في النموذج إذا كان في وضع التعديل
      if (editId) {
        const task = tasks.find(t => t.id === editId);
        if (task) {
          document.getElementById("title").value = task.title || "";
          document.getElementById("requester").value = task.requester || "";
          document.getElementById("type").value = task.type || "";
          document.getElementById("size").value = task.size || "";
          document.getElementById("link").value = task.link || "";
          document.getElementById("deadline").value = task.deadline ? task.deadline.split('T')[0] : "";
          document.getElementById("department").value = task.department || "كرييتف";
          document.getElementById("priority").value = task.priority || "متوسط";
          document.getElementById("description").value = task.description || "";
          
          // تحديد العلامات المختارة
          if (task.tags && task.tags.length > 0) {
            document.querySelectorAll('.tag-checkbox').forEach(checkbox => {
              if (task.tags.includes(checkbox.value)) {
                checkbox.checked = true;
              }
            });
          }
        }
      }
      
      // إظهار المودال
      document.getElementById('task-modal').classList.add('show');
    }
    
    // دالة حفظ الطلب (إضافة أو تعديل)
    function saveTask() {
      // التحقق من الحقول المطلوبة
      if (!val("title") || !val("requester")) {
        showNotification("يرجى تعبئة جميع الحقول المطلوبة", "error");
        return;
      }
      
      // جمع العلامات المحددة
      const selectedTags = [];
      document.querySelectorAll('.tag-checkbox:checked').forEach(checkbox => {
        selectedTags.push(checkbox.value);
      });
      
      try {
        if (editId) {
          // تحديث المهمة الموجودة
          const taskIndex = tasks.findIndex(t => t.id === editId);
          if (taskIndex !== -1) {
            const oldTask = tasks[taskIndex];
            tasks[taskIndex] = {
              ...oldTask,
              title: val("title"),
              requester: val("requester"),
              type: val("type"),
              size: val("size"),
              link: val("link"),
              deadline: val("deadline"),
              department: val("department"),
              priority: val("priority"),
              description: val("description"),
              tags: selectedTags,
              updatedAt: new Date().toISOString()
            };
            
            // تسجيل النشاط
            logActivity('تعديل طلب', editId);
            
            showNotification(`تم تحديث الطلب بنجاح: ${val("title")}`);
          }
          editId = null;
        } else {
          // إضافة مهمة جديدة
          const newTask = {
            id: Date.now(),
            title: val("title"),
            requester: val("requester"),
            type: val("type"),
            size: val("size"),
            link: val("link"),
            deadline: val("deadline"),
            department: val("department"),
            priority: val("priority"),
            description: val("description"),
            status: "غير منجز",
            tags: selectedTags,
            createdAt: new Date().toISOString(),
            assignedTo: null,
            attachments: []
          };
          
          tasks.unshift(newTask);  // إضافة في بداية المصفوفة
          
          // تسجيل النشاط
          logActivity('إضافة طلب', newTask.id);
          
          showNotification(`تم إضافة الطلب بنجاح: ${val("title")}`);
        }
        
        // حفظ التغييرات
        localStorage.setItem("tasks", JSON.stringify(tasks));
        
        // إغلاق المودال وتحديث الواجهة
        document.getElementById('task-modal').classList.remove('show');
        updateUI();
        
      } catch (e) {
        console.error("خطأ في إضافة/تعديل المهمة:", e);
        showNotification("حدث خطأ أثناء حفظ البيانات", "error");
      }
    }
    
    // دالة إلغاء التعديل
    function cancelEdit() {
      editId = null;
      document.getElementById('task-modal').classList.remove('show');
    }
    
    // دالة حذف الطلب
    function deleteTask() {
      if (!deleteTaskId) return;
      
      try {
        // البحث عن اسم الطلب للنشاط
        const task = tasks.find(t => t.id === deleteTaskId);
        const taskTitle = task ? task.title : 'طلب محذوف';
        
        // حذف المهمة
        tasks = tasks.filter(t => t.id !== deleteTaskId);
        
        // حذف التعليقات المتعلقة بها
        if (comments[deleteTaskId]) {
          delete comments[deleteTaskId];
        }
        
        // تسجيل النشاط
        logActivity('حذف طلب', deleteTaskId, taskTitle);
        
        // حفظ التغييرات
        localStorage.setItem("tasks", JSON.stringify(tasks));
        localStorage.setItem("comments", JSON.stringify(comments));
        
        // إغلاق مودال التأكيد وتحديث الواجهة
        document.getElementById('confirm-modal').classList.remove('show');
        updateUI();
        
        showNotification("تم حذف الطلب بنجاح");
        
      } catch (e) {
        console.error("خطأ في حذف المهمة:", e);
        showNotification("حدث خطأ أثناء حذف البيانات", "error");
      }
      
      deleteTaskId = null;
    }
    
    // دالة تأكيد حذف الطلب
    function confirmDeleteTask(id) {
      deleteTaskId = id;
      document.getElementById('confirm-modal').classList.add('show');
    }
    
    // دالة نسخ الطلب
    function duplicateTask(id) {
      const task = tasks.find(t => t.id === id);
      if (task) {
        const newTask = {
          ...task,
          id: Date.now(),
          title: `نسخة من ${task.title}`,
          status: "غير منجز",
          createdAt: new Date().toISOString(),
          assignedTo: null // إزالة المسؤول
        };
        
        // حذف تاريخ الإنجاز إن وجد
        if (newTask.completedAt) {
          delete newTask.completedAt;
        }
        
        tasks.unshift(newTask);
        
        // تسجيل النشاط
        logActivity('نسخ طلب', newTask.id, `نسخة من: ${task.title}`);
        
        localStorage.setItem("tasks", JSON.stringify(tasks));
        updateUI();
        
        showNotification(`تم نسخ الطلب بنجاح: ${newTask.title}`);
      }
    }
    
    // دالة تعديل الطلب
    function editTask(id) {
      editId = id;
      openTaskModal();
    }
    
    // دالة تبديل وضع الألوان
    function toggleMode() {
      darkMode = !darkMode;
      localStorage.setItem("darkMode", darkMode);
      updateUI();
    }
    
    // دالة تعيين وضع الألوان
    function setDarkMode(isDark) {
      darkMode = isDark;
      localStorage.setItem("darkMode", darkMode);
      updateUI();
    }
    
    // دالة تصدير البيانات
    function exportData() {
      try {
        const data = {
          tasks: tasks,
          comments: comments,
          activityLog: activityLog,
          version: "2.0",
          exportDate: new Date().toISOString()
        };
        
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", `task_manager_backup_${new Date().toISOString().slice(0, 10)}.json`);
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
        
        showNotification("تم تصدير البيانات بنجاح");
      } catch (e) {
        console.error("خطأ في تصدير البيانات:", e);
        showNotification("حدث خطأ أثناء تصدير البيانات", "error");
      }
    }
    
    // دالة تصدير الطلبات فقط
    function exportTasks() {
      try {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(tasks, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", `tasks_export_${new Date().toISOString().slice(0, 10)}.json`);
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
        
        showNotification("تم تصدير الطلبات بنجاح");
      } catch (e) {
        console.error("خطأ في تصدير الطلبات:", e);
        showNotification("حدث خطأ أثناء تصدير الطلبات", "error");
      }
    }
    
    // دالة تصدير تقرير
    function exportReport() {
      showNotification("جاري تصدير التقرير...");
      setTimeout(() => {
        try {
          // إنشاء نص التقرير
          const completedTasks = tasks.filter(t => t.status === "منجز").length;
          const totalTasks = tasks.length;
          const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
          
          const reportData = {
            title: "تقرير نظام إدارة الطلبات",
            date: new Date().toLocaleDateString('en-US'),
            summary: {
              totalTasks,
              completedTasks,
              pendingTasks: tasks.filter(t => t.status === "غير منجز").length,
              inProgressTasks: tasks.filter(t => t.status === "جاري العمل").length,
              completionRate: completionRate + "%",
              overdueTasks: tasks.filter(t => {
                if (!t.deadline || t.status === "منجز" || t.status === "ملغي") return false;
                return new Date(t.deadline) < new Date();
              }).length
            },
            departmentStats: {},
            statusStats: {},
            recentActivity: activityLog.slice(0, 10)
          };
          
          // إحصاءات الأقسام
          Object.keys(departments).forEach(dept => {
            reportData.departmentStats[dept] = tasks.filter(t => t.department === dept).length;
          });
          
          // إحصاءات الحالات
          Object.keys(statuses).forEach(status => {
            reportData.statusStats[status] = tasks.filter(t => t.status === status).length;
          });
          
          const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(reportData, null, 2));
          const downloadAnchorNode = document.createElement('a');
          downloadAnchorNode.setAttribute("href", dataStr);
          downloadAnchorNode.setAttribute("download", `report_${new Date().toISOString().slice(0, 10)}.json`);
          document.body.appendChild(downloadAnchorNode);
          downloadAnchorNode.click();
          downloadAnchorNode.remove();
          
          showNotification("تم تصدير التقرير بنجاح");
        } catch (e) {
          console.error("خطأ في تصدير التقرير:", e);
          showNotification("حدث خطأ أثناء تصدير التقرير", "error");
        }
      }, 500);
    }
    
    // دالة استيراد البيانات
    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          if (data.tasks) {
            tasks = data.tasks;
            localStorage.setItem("tasks", JSON.stringify(tasks));
          }
          
          if (data.comments) {
            comments = data.comments;
            localStorage.setItem("comments", JSON.stringify(comments));
          }
          
          if (data.activityLog) {
            activityLog = data.activityLog;
            localStorage.setItem("activityLog", JSON.stringify(activityLog));
          }
          
          updateUI();
          showNotification("تم استيراد البيانات بنجاح");
        } catch (e) {
          console.error("خطأ في استيراد البيانات:", e);
          showNotification("حدث خطأ أثناء استيراد البيانات", "error");
        }
      };
      
      reader.readAsText(file);
    }
    
    // دالة حذف جميع الطلبات
    function clearTasks() {
      if (confirm("هل أنت متأكد من رغبتك في حذف جميع الطلبات؟ لا يمكن التراجع عن هذه العملية.")) {
        tasks = [];
        localStorage.setItem("tasks", JSON.stringify(tasks));
        updateUI();
        showNotification("تم حذف جميع الطلبات بنجاح");
      }
    }
    
    // دالة حذف جميع التعليقات
    function clearComments() {
      if (confirm("هل أنت متأكد من رغبتك في حذف جميع التعليقات؟ لا يمكن التراجع عن هذه العملية.")) {
        comments = {};
        localStorage.setItem("comments", JSON.stringify(comments));
        updateUI();
        showNotification("تم حذف جميع التعليقات بنجاح");
      }
    }
    
    // دالة حذف سجل الأنشطة
    function clearActivityLog() {
      if (confirm("هل أنت متأكد من رغبتك في حذف سجل الأنشطة؟ لا يمكن التراجع عن هذه العملية.")) {
        activityLog = [];
        localStorage.setItem("activityLog", JSON.stringify(activityLog));
        updateUI();
        showNotification("تم حذف سجل الأنشطة بنجاح");
      }
    }
    
    // دالة إعادة تعيين النظام بالكامل
    function resetAll() {
      if (confirm("هل أنت متأكد من رغبتك في إعادة تعيين النظام بالكامل؟ سيتم حذف جميع البيانات ولا يمكن التراجع عن هذه العملية.")) {
        tasks = [];
        comments = {};
        activityLog = [];
        localStorage.setItem("tasks", JSON.stringify(tasks));
        localStorage.setItem("comments", JSON.stringify(comments));
        localStorage.setItem("activityLog", JSON.stringify(activityLog));
        updateUI();
        showNotification("تم إعادة تعيين النظام بنجاح");
      }
    }
    
    // =================== محملات الأحداث ===================
    
    // تبديل الشريط الجانبي
    document.getElementById('toggle-sidebar').addEventListener('click', () => {
      sidebarCollapsed = !sidebarCollapsed;
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('collapsed', sidebarCollapsed);
      document.querySelectorAll('.sidebar-text').forEach(span => {
        span.classList.toggle('hidden', sidebarCollapsed);
      });
    });
    
    // التنقل بين الأقسام
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        activeSection = tab.getAttribute('data-section');
        updateUI();
      });
    });
    
    // زر إضافة طلب جديد
    document.getElementById('add-task-btn').addEventListener('click', () => {
      editId = null;
      openTaskModal();
    });
    
    // إغلاق مودال الطلب
    document.getElementById('close-modal').addEventListener('click', () => {
      document.getElementById('task-modal').classList.remove('show');
    });
    
    // إغلاق مودال تفاصيل الطلب
    document.getElementById('close-details-modal').addEventListener('click', () => {
      document.getElementById('task-details-modal').classList.remove('show');
    });
    
    // مودال تأكيد الحذف
    document.getElementById('confirm-delete').addEventListener('click', deleteTask);
    document.getElementById('cancel-delete').addEventListener('click', () => {
      document.getElementById('confirm-modal').classList.remove('show');
      deleteTaskId = null;
    });
    
    // إغلاق المودالات عند النقر خارجها
    document.querySelectorAll('.modal-backdrop').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('show');
        }
      });
    });
    
    // =================== التهيئة الأولية ===================
    
    // بدء تشغيل التطبيق
    updateUI(); 

    function checkUpcomingDeadlines() {
      const now = new Date();
      const twoDaysFromNow = new Date();
      twoDaysFromNow.setDate(now.getDate() + 2);

      const upcomingTasks = tasks.filter(t => {
        if (!t.deadline || t.status === "منجز" || t.status === "ملغي") return false;
        const deadline = new Date(t.deadline);
        return deadline > now && deadline <= twoDaysFromNow;
      });

      if (upcomingTasks.length > 0) {
        const titles = upcomingTasks.map(t => t.title).join("، ");
        showNotification(`📌 اقترب موعد التسليم للطلبات: ${titles}`, "warning");
      }
    }
  </script>
</body>
</html>